apiVersion: v1
kind: Namespace
metadata:
  name: oma-demo
  labels:
    purpose: k8s-causal-memory-poc
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-mount-config
  namespace: oma-demo
data:
  config.yaml: |
    server:
      port: 8080
      timeout: 30s
    database:
      pool_size: 10
      max_idle: 5
    feature_flags:
      new_ui: false
      dark_mode: false
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-consumer-mount
  namespace: oma-demo
  labels:
    app: config-consumer-mount
    scenario: "03-configmap-mount"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-consumer-mount
  template:
    metadata:
      labels:
        app: config-consumer-mount
    spec:
      containers:
      - name: app
        image: busybox
        command:
        - sh
        - -c
        - |
          echo "=== Pod started at $(date) ==="
          echo "=== Config mounted at /etc/app-config ==="
          ls -la /etc/app-config/
          echo ""
          echo "=== Initial config.yaml ==="
          cat /etc/app-config/config.yaml
          echo ""
          echo "=== Watching for kubelet symlink swap ==="
          PREV=$(cat /etc/app-config/config.yaml)
          while true; do
            CURR=$(cat /etc/app-config/config.yaml)
            if [ "$CURR" != "$PREV" ]; then
              echo "[$(date)] CONFIG CHANGED via symlink swap!"
              echo "New content:"
              cat /etc/app-config/config.yaml
              PREV=$CURR
            fi
            sleep 5
          done
        volumeMounts:
        - name: config-volume
          mountPath: /etc/app-config
          readOnly: true
        resources:
          requests:
            memory: "16Mi"
            cpu: "10m"
          limits:
            memory: "32Mi"
            cpu: "50m"
      volumes:
      - name: config-volume
        configMap:
          name: app-mount-config
