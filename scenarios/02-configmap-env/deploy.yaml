apiVersion: v1
kind: Namespace
metadata:
  name: oma-demo
  labels:
    purpose: k8s-causal-memory-poc
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-feature-config
  namespace: oma-demo
data:
  feature.flag: "disabled"
  db.pool.size: "10"
  log.level: "info"
  api.timeout.ms: "3000"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-consumer-env
  namespace: oma-demo
  labels:
    app: config-consumer-env
    scenario: "02-configmap-env"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: config-consumer-env
  template:
    metadata:
      labels:
        app: config-consumer-env
    spec:
      containers:
      - name: app
        image: busybox
        command:
        - sh
        - -c
        - |
          echo "=== Pod started at $(date) ==="
          echo "FEATURE_FLAG=$FEATURE_FLAG  DB_POOL_SIZE=$DB_POOL_SIZE"
          while true; do
            echo "[$(date)] Running: feature=$FEATURE_FLAG pool=$DB_POOL_SIZE"
            sleep 30
          done
        env:
        - name: FEATURE_FLAG
          valueFrom:
            configMapKeyRef:
              name: app-feature-config
              key: feature.flag
        - name: DB_POOL_SIZE
          valueFrom:
            configMapKeyRef:
              name: app-feature-config
              key: db.pool.size
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: app-feature-config
              key: log.level
        - name: API_TIMEOUT_MS
          valueFrom:
            configMapKeyRef:
              name: app-feature-config
              key: api.timeout.ms
        resources:
          requests:
            memory: "16Mi"
            cpu: "10m"
          limits:
            memory: "32Mi"
            cpu: "50m"
